name: Generate Screenshots

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight (optional)

jobs:
  screenshot-linux:
    name: Generate Linux Screenshots
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            x11-utils \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-xfixes0 \
            libxcb-cursor0 \
            libegl1 \
            libglib2.0-0 \
            libdbus-1-3
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Generate screenshots
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 3
          python scripts/take_screenshots.py
        env:
          QT_QPA_PLATFORM: xcb
      
      - name: Upload Linux screenshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-linux
          path: screenshots/screenshot-linux-*.png
          retention-days: 30

  screenshot-windows:
    name: Generate Windows Screenshots
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Generate screenshots
        timeout-minutes: 5
        run: |
          echo "Starting screenshot generation..."
          python scripts/take_screenshots.py 2>&1 | Tee-Object -FilePath screenshot_log.txt
          echo "Screenshot generation completed with exit code: $LASTEXITCODE"
          exit $LASTEXITCODE
        env:
          QT_QPA_PLATFORM: offscreen
          QT_DEBUG_PLUGINS: 1
          MPLBACKEND: Agg
          MPLCONFIGDIR: ${{ runner.temp }}/.matplotlib
          PYTHONUNBUFFERED: 1
        continue-on-error: true
      
      - name: Upload screenshot log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-screenshot-log
          path: screenshot_log.txt
          retention-days: 7
      
      - name: Check if screenshots were created
        id: check_screenshots
        shell: bash
        run: |
          if [ -f screenshots/screenshot-win-dark.png ] && [ -f screenshots/screenshot-win-light.png ]; then
            echo "has_screenshots=true" >> $GITHUB_OUTPUT
          else
            echo "has_screenshots=false" >> $GITHUB_OUTPUT
            echo "Windows screenshots not generated - this is expected and may require further debugging"
          fi
      
      - name: Upload Windows screenshots
        if: steps.check_screenshots.outputs.has_screenshots == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-windows
          path: screenshots/screenshot-win-*.png
          retention-days: 30

  commit-screenshots:
    name: Commit Screenshots to Repository
    needs: [screenshot-linux, screenshot-windows]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Linux screenshots
        uses: actions/download-artifact@v4
        with:
          name: screenshots-linux
          path: screenshots-linux
        continue-on-error: true
      
      - name: Download Windows screenshots
        uses: actions/download-artifact@v4
        with:
          name: screenshots-windows
          path: screenshots-windows
        continue-on-error: true
      
      - name: Move screenshots to repository
        run: |
          mkdir -p screenshots
          cp screenshots-linux/*.png screenshots/ || true
          cp screenshots-windows/*.png screenshots/ || true
          ls -lh screenshots/
      
      - name: Check for changes
        id: check_changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add screenshots/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push screenshots
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git commit -m "chore: update automated screenshots

          Generated screenshots for both Linux and Windows platforms in light and dark themes.
          
          - Linux: screenshot-linux-dark.png, screenshot-linux-light.png
          - Windows: screenshot-win-dark.png, screenshot-win-light.png"
          git push
      
      - name: No changes detected
        if: steps.check_changes.outputs.has_changes == 'false'
        run: echo "No screenshot changes detected - skipping commit"
